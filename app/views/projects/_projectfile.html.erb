<%# projects with audio %>
<% if @project.audio_id?
    audio_codec_params = "none"
    offset_params = "2"
    audio_overlay_video = {angle: @project.video.rotation,flags:"splice", overlay:"video:"+Rails.env+":"+@project.video.file.key, start_offset:offset_params},
      {:flags=>"layer_apply", :start_offset=>"2"}
    audio_overlay = {overlay: "video:"+Rails.env+":"+@project.audio.file.key}
  else
    audio_codec_params = nil
    offset_params = nil
    audio_overlay_video = nil
  end%>
<%# projects with backgrounds %>
<% if @project.background_id?
    text_box_width = @project.background.width
    text_box_height = @project.background.text_box_height
    text_box_x = @project.background.x_axis
    text_box_y = @project.background.y_axis
    project_angle = @project.background.angle
    underlay_params = {underlay: Rails.env+":"+@project.background.photo.key,
                      width: 1280,
                      crop: "scale"}
# projects without backgrounds
  else
    text_box_width = @project.video.text_width
    text_box_height = @project.video.text_box_height
    text_box_x = @project.video.x_axis
    text_box_y = @project.video.y_axis
    project_angle = @project.video.angle
    underlay_params = nil
  end%>
<%# projects with text distortion %>
<% if @project.background_id && @project.background.text_distortion == true
      distortion_params = "#{@project.background.distort_nw_x}:#{@project.background.distort_nw_y}:#{@project.background.distort_ne_x}:#{@project.background.distort_ne_y}:#{@project.background.distort_se_x}:#{@project.background.distort_se_y}:#{@project.background.distort_sw_x}:#{@project.background.distort_sw_x}:"
    elsif @project.video.text_distortion == true
      distortion_params = "#{@project.video.distort_nw_x}:#{@project.video.distort_nw_y}:#{@project.video.distort_ne_x}:#{@project.video.distort_ne_y}:#{@project.video.distort_se_x}:#{@project.video.distort_se_y}:#{@project.video.distort_sw_x}:#{@project.video.distort_sw_x}:"
    else
      distortion_params = nil
  end%>

<%= cl_video_tag(@project.video.file.key,
    controls: true,
    preload: "metadata",
    width: "100%",
    poster: false,
    :transformation=>[
      {audio_codec:audio_codec_params, end_offset:offset_params, quality:"auto", crop:"scale"},
      {angle: @project.video.rotation},
      audio_overlay_video,
      # background underlay
      underlay_params,
      # audio overlay
      audio_overlay,
      # text overlay
      {angle:project_angle, distort:distortion_params, :gravity=>"north_west",
      :overlay=>{
        font_family: @project.font,font_size: @project.font_size,
        text: @project.message + "%0d"+ @project.message_body + "%0d"+ @project.message_body_two},
        opacity: @project.opacity,width: text_box_width,height: text_box_height,
        x: text_box_x,y: text_box_y,crop: "fit",}
  ]) %>
