<%# projects with multiple videos %>
  <% reiterate = @project.videos.count.to_i - 1%>
  <% video_pos = 0 %>
  <% reiterate.times do
    video_pos += 1 %>

  <% end%>

<%# projects with audio %>
<% if @project.audios.exists?
    audio_codec_params = "none"
    offset_params = "2"
    audio_overlay_video = {flags:"splice", overlay:"video:"+Rails.env+":"+@project.videos[0].file.key, start_offset:offset_params},
      {:flags=>"layer_apply", :start_offset=>"2"}
    audio_overlay = {overlay: "video:"+Rails.env+":"+@project.audios[0].file.key}
  else
    audio_codec_params = nil
    offset_params = nil
    audio_overlay_video = nil
  end%>

<%# projects with backgrounds %>
<% if @project.background_id?
    text_box_width = @project.background.width
    text_box_height = @project.background.text_box_height
    text_box_x = @project.background.x_axis
    text_box_y = @project.background.y_axis
    project_angle = @project.background.angle
    underlay_params = {underlay: Rails.env+":"+@project.background.photo.key,
                      width: 1280,
                      crop: "scale"}, {effect: "fade:1"}
# projects without backgrounds
  else
    text_box_width = @project.videos[0].text_width
    text_box_height = @project.videos[0].text_box_height
    text_box_x = @project.videos[0].x_axis
    text_box_y = @project.videos[0].y_axis
    project_angle = @project.videos[0].angle
    underlay_params = nil
  end%>
<%# projects with text distortion %>
<% if @project.background_id && @project.background.text_distortion == true
      distortion_params = "#{@project.background.distort_nw_x}:#{@project.background.distort_nw_y}:#{@project.background.distort_ne_x}:#{@project.background.distort_ne_y}:#{@project.background.distort_se_x}:#{@project.background.distort_se_y}:#{@project.background.distort_sw_x}:#{@project.background.distort_sw_x}:"
    elsif @project.videos[0].text_distortion == true
      distortion_params = "#{@project.videos[0].distort_nw_x}:#{@project.videos[0].distort_nw_y}:#{@project.videos[0].distort_ne_x}:#{@project.videos[0].distort_ne_y}:#{@project.videos[0].distort_se_x}:#{@project.videos[0].distort_se_y}:#{@project.videos[0].distort_sw_x}:#{@project.videos[0].distort_sw_x}:"
    else
      distortion_params = nil
  end%>

  <%# text overlay %>
  <% if @project.message_body? %>
  <%  message_params = {angle:project_angle, distort:distortion_params, :gravity=>"north_west",
              :overlay=>{
                font_family: @project.font,font_size: @project.font_size,
                text: @project.message_body},
                opacity: @project.opacity,width: text_box_width,height: text_box_height,
                x: text_box_x,y: text_box_y,crop: "fit",} %>
  <% else
      message_params = nil %>
  <% end %>


<%= cl_video_tag(@project.videos[0].file.key,
    controls: true,
    preload: "metadata",
    width: "100%",
    poster: @project.thumbnail_key+".jpg",
    :transformation=>[
      {audio_codec:audio_codec_params, effect: "fade:1",end_offset:offset_params, quality:"auto", crop:"scale"},
      audio_overlay_video,
      # background underlay
      # underlay_params, **uncomment this line if you want to add backgrounds/images**
      # audio overlay
      audio_overlay,
      # params for multiple videos
      {flags: "splice", overlay: "video:"+Rails.env+":"+@project.videos[1].file.key},
      {flags: "splice", overlay: "video:"+Rails.env+":"+@project.videos[2].file.key},
      # text overlay
      message_params

  ]) %>
